# How to train Tesseract 4 from CNI tiff/box pairs

## Installation and prerequisites

You must install Tesseract 4 with the training tools.

```
make training
sudo make training-install
```

You have to apply a local patch to tesseract:

```
diff --git a/training/tesstrain_utils.sh b/training/tesstrain_utils.sh
index 227d15f3..b354ce50 100755
--- a/training/tesstrain_utils.sh
+++ b/training/tesstrain_utils.sh
@@ -398,8 +398,12 @@ phase_E_extract_features() {
     tlog "Using TESSDATA_PREFIX=${TESSDATA_PREFIX}"
     local counter=0
     for img_file in ${img_files}; do
+        local img_config=""
+        if [[ $img_file == *franceocr* ]]; then
+            img_config="--psm 7"
+        fi
         run_command tesseract ${img_file} ${img_file%.*} \
-            ${box_config} ${config} &
+            ${img_config} ${box_config} ${config} &
       let counter=counter+1
       let rem=counter%par_factor
       if [[ "${rem}" -eq 0 ]]; then
```

You must download `eng` and `common` tesseract training data in the `/training/langdata` folder.

## Pipeline

The `pipeline.sh` bash script is enough to fine-tune the neural network.

It runs the following steps :

* Reset temp directory
* Add tif/box pairs to lang data
* Generate training data (lstmf files)
* Generate list of wanted lstmf files (we only train of the tiff/box pairs, not on artificial data generated by the previous script)
* Extract english neural network weights
* Train: fine-tune english neural network weights with our tiff/box pairs
* Once the network has converged, pack the weights
* Copy english trained data
* Replace old english weights with fine-tuned ones
* Copy the generated traineddata to the `api` folder.
* System-install new lang data "franceocr"

## Utilities

### `make_box.py`

`make_box.py` is a Python script which helps bootstrap box files.

Provided a tiff image of a string, the x-coordinate of the first letter and the string, the script generates a box file associated to the tiff.
E.g. `python make_box.py to_process/eng.franceocr53.exp0.tif 0 "PARIS (75)"`
